<!DOCTYPE html>
<html lang="es"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Favoritos ‚ú®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class', // Habilita el modo oscuro
            theme: {
                extend: {
                    // Color de acento
                    colors: {
                        accent: {
                            500: '#3b82f6', // azul-500
                            600: '#2563eb', // azul-600
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Fuente m√°s limpia */
        body { font-family: 'Inter', sans-serif; }
        
        /* Ocultar modales por defecto */
        .modal { display: none; }
        .modal.flex { display: flex; }
        
        /* Estilos de "fantasma" para Drag & Drop */
        .sortable-ghost {
            opacity: 0.4;
            background: #e0e7ff; /* indigo-100 */
        }
        .dark .sortable-ghost {
            background: #3730a3; /* indigo-900 */
        }

        /* Toast de Deshacer */
        #undo-toast {
            transform: translateY(120%);
            transition: transform 0.3s ease-in-out;
            visibility: hidden;
        }
        #undo-toast.show {
            transform: translateY(0);
            visibility: visible;
        }
        
        /* Estilos para ocultar/mostrar controles sutiles */
        .link-item .link-actions,
        .link-item .link-drag-handle,
        .category-header .category-actions,
        .category-header .category-drag-handle {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        
        /* Mostrar al pasar el rat√≥n por encima (en PC) */
        .link-item:hover .link-actions,
        .link-item:hover .link-drag-handle,
        .category-header:hover .category-actions,
        .category-header:hover .category-drag-handle {
            opacity: 0.5; /* Sutil */
        }
        
        /* Mostrar siempre en pantallas t√°ctiles (m√≥viles) */
        @media (pointer: coarse) {
            .link-item .link-actions,
            .link-item .link-drag-handle,
            .category-header .category-actions,
            .category-header .category-drag-handle {
                opacity: 0.3;
            }
        }
        
        .link-item .link-actions:hover,
        .link-item .link-drag-handle:hover,
        .category-header .category-actions:hover,
        .category-header .category-drag-handle:hover {
            opacity: 1; /* Opacidad total al apuntar al control */
        }

    </style>
</head>
<body class="bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 min-h-screen p-4 md:p-8 transition-colors duration-200 antialiased">

    <div class="max-w-4xl mx-auto">

        <header class="mb-10">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Favoritos</h1>
                <div class="flex gap-2">
                    <button id="add-link-btn" class="flex items-center gap-1.5 bg-accent-500 hover:bg-accent-600 text-white font-medium py-2 px-3.5 rounded-lg transition-all text-sm">
                        <ion-icon name="add-outline" class="text-xl"></ion-icon>
                        Enlace
                    </button>
                    <button id="add-category-btn" class="flex items-center gap-1.5 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium py-2 px-3.5 rounded-lg transition-all text-sm">
                        <ion-icon name="duplicate-outline" class="text-lg"></ion-icon>
                        Categor√≠a
                    </button>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-3">
                <div class="relative flex-grow">
                    <input type="search" id="search-input" placeholder="Buscar en todos los enlaces..." class="w-full p-3 pl-10 bg-gray-100 dark:bg-gray-800 border border-transparent focus:border-accent-500 dark:border-transparent dark:focus:border-accent-500 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-accent-500/50 transition-colors">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <ion-icon name="search-outline" class="text-gray-500 dark:text-gray-400"></ion-icon>
                    </div>
                </div>

                <div class="flex gap-2 flex-shrink-0">
                    <button id="import-btn" class="bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold p-3 rounded-lg transition-colors flex items-center" title="Importar desde .json">
                        <ion-icon name="arrow-up-outline" class="text-xl"></ion-icon>
                    </button>
                    <button id="export-btn" class="bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold p-3 rounded-lg transition-colors flex items-center" title="Exportar a .json">
                        <ion-icon name="arrow-down-outline" class="text-xl"></ion-icon>
                    </button>
                    <input type="file" id="import-file" accept=".json" class="hidden">
                    <button id="theme-toggle-btn" class="bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold p-3 rounded-lg transition-colors flex items-center" title="Cambiar tema">
                        <ion-icon name="sunny-outline" class="text-xl"></ion-icon>
                    </button>
                </div>
            </div>
        </header>

        <main id="categories-container" class="space-y-10">
            </main>
    </div>

    <div id="category-modal" class="modal fixed inset-0 bg-black/60 backdrop-blur-sm items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <h2 id="category-modal-title" class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Crear Nueva Categor√≠a</h2>
            <form id="category-form">
                <div>
                    <label for="category-name" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Nombre de la Categor√≠a</label>
                    <input type="text" id="category-name" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-accent-500" placeholder="Ej: Herramientas de Dise√±o" required>
                </div>
                <div id="category-error" class="text-red-500 dark:text-red-400 text-sm mt-2 hidden"></div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="modal-close-btn bg-gray-100 hover:bg-gray-200 text-gray-700 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="bg-accent-500 hover:bg-accent-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="link-modal" class="modal fixed inset-0 bg-black/60 backdrop-blur-sm items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <h2 id="link-modal-title" class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">A√±adir Nuevo Enlace</h2>
            <form id="link-form" class="space-y-4">
                <div>
                    <label for="link-title" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">T√≠tulo</label>
                    <input type="text" id="link-title" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-accent-500" placeholder="Ej: Google" required>
                </div>
                <div>
                    <label for="link-url" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">URL (Enlace)</label>
                    <input type="text" id="link-url" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-accent-500" placeholder="Ej: https://www.google.com" required>
                </div>
                <div>
                    <label for="link-description" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Descripci√≥n (Opcional)</label>
                    <textarea id="link-description" rows="2" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-accent-500" placeholder="Ej: Buscador web r√°pido y eficiente"></textarea>
                </div>
                <div>
                    <label for="link-tags" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Etiquetas (Opcional, separadas por coma)</label>
                    <input type="text" id="link-tags" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-accent-500" placeholder="Ej: busqueda, google, utilidades">
                </div>
                <div>
                    <label for="link-category" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Categor√≠a</label>
                    <select id="link-category" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-accent-500" required>
                    </select>
                </div>
                <div id="link-error" class="text-red-500 dark:text-red-400 text-sm pt-2 hidden"></div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" class="modal-close-btn bg-gray-100 hover:bg-gray-200 text-gray-700 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="bg-accent-500 hover:bg-accent-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="undo-toast" class="fixed bottom-6 left-6 bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 p-4 rounded-lg shadow-lg flex items-center gap-4 z-50">
        <span class="font-medium">Enlace eliminado.</span>
        <button id="undo-btn" class="font-bold text-accent-400 dark:text-accent-600 hover:text-accent-300 dark:hover:text-accent-500">Deshacer</button>
    </div>

    <button id="back-to-top-btn" class="hidden fixed bottom-6 right-6 bg-accent-500 hover:bg-accent-600 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-opacity duration-300 z-40">
        <ion-icon name="arrow-up-outline" class="text-2xl"></ion-icon>
    </button>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- CONSTANTES DE DATOS Y DOM ---
            const STORAGE_KEY_BOOKMARKS = 'dinamicBookmarks';
            const STORAGE_KEY_ORDER = 'dinamicBookmarksOrder';
            const STORAGE_KEY_THEME = 'dinamicBookmarksTheme';
            
            
            // --- ¬°¬°¬°TUS DATOS PREDETERMINADOS!!! ---
            const DEFAULT_BOOKMARKS = {
                "üîé B√∫squeda y Noticias": [
                    {"title": "Google", "url": "https://www.google.com", "description": "Buscador web", "tags": []},
                    {"title": "La Nueva", "url": "https://www.lanueva.com/", "description": "Noticias Locales y de la Argentina", "tags": []},
                    {"title": "La Br√∫jula", "url": "https://www.labrujula24.com/", "description": "Noticias Locales y de la Argentina", "tags": []},
                    {"title": "Infobae", "url": "https://www.infobae.com/", "description": "Infobae", "tags": []},
                    {"title": "DuckDuckGo", "url": "https://duckduckgo.com", "description": "Un buscador enfocado en la privacidad que no rastrea tu historial de b√∫squeda.", "tags": ["busqueda", "privacidad", "motor"]},
                    {"title": "Google News", "url": "https://news.google.com", "description": "Agregador de noticias de Google, personalizado seg√∫n tus intereses.", "tags": ["noticias", "google", "agregador"]},
                    {"title": "Feedly", "url": "https://feedly.com", "description": "Lector de RSS para seguir blogs y sitios de noticias en un solo lugar.", "tags": ["rss", "noticias", "blogs", "tecnologia"]}
                ],
                "üé¨ Entretenimiento": [
                    {"title": "YouTube", "url": "https://www.youtube.com", "description": "Plataforma de videos", "tags": []},
                    {"title": "TikTok", "url": "https://www.tiktok.com/es/", "description": "Videos cortos", "tags": []},
                    {"title": "Twitch", "url": "https://www.twitch.tv/", "description": "Twitch", "tags": []},
                    {"title": "Spotify (Web Player)", "url": "https://open.spotify.com", "description": "Escucha m√∫sica y podcasts directamente desde el navegador.", "tags": ["musica", "podcast", "streaming"]},
                    {"title": "Reddit", "url": "https://www.reddit.com", "description": "La \"portada de internet\". Foros y comunidades (subreddits) sobre cualquier tema.", "tags": ["comunidad", "foros", "noticias"]},
                    {"title": "Letterboxd", "url": "https://letterboxd.com", "description": "Red social para cin√©filos. Registra, califica y descubre pel√≠culas.", "tags": ["cine", "peliculas", "social"]}
                ],
                "üí¨ Redes Sociales": [
                    {"title": "Twitter / X", "url": "https://twitter.com", "description": "Red social de noticias y tendencias", "tags": []},
                    {"title": "Facebook", "url": "https://www.facebook.com", "description": "Red social para compartir con amigos", "tags": []},
                    {"title": "Instagram", "url": "https://www.instagram.com", "description": "Fotos, videos y contenido de creadores", "tags": []},
                    {"title": "WhatsApp Web", "url": "https://web.whatsapp.com", "description": "Usa WhatsApp directamente desde tu computadora.", "tags": ["chat", "mensajeria", "social"]},
                    {"title": "LinkedIn", "url": "https://www.linkedin.com", "description": "Red social profesional para networking, perfiles de trabajo y noticias del sector.", "tags": ["profesional", "trabajo", "networking"]},
                    {"title": "Discord", "url": "https://discord.com/app", "description": "Plataforma de chat por voz, video y texto para comunidades.", "tags": ["chat", "comunidad", "gaming"]}
                ],
                "üë®‚Äçüíª Tecnolog√≠a / Trabajo": [
                    {"title": "GitHub", "url": "https://github.com", "description": "Repositorio y colaboraci√≥n de proyectos de c√≥digo", "tags": []},
                    {"title": "Gmail", "url": "https://mail.google.com/mail/u/0/#inbox", "description": "Correo electr√≥nico de Google", "tags": []},
                    {"title": "Google Calendar", "url": "https://calendar.google.com", "description": "Calendario y eventos online", "tags": []},
                    {"title": "Notion", "url": "https://www.notion.so", "description": "Espacio de trabajo todo-en-uno para notas, tareas, wikis y bases de datos.", "tags": ["productividad", "notas", "wiki"]},
                    {"title": "Google Drive", "url": "https://drive.google.com", "description": "Almacenamiento en la nube, documentos, hojas de c√°lculo y presentaciones de Google.", "tags": ["nube", "docs", "google", "oficina"]},
                    {"title": "Trello", "url": "https://trello.com", "description": "Herramienta visual de gesti√≥n de proyectos estilo Kanban (tableros y tarjetas).", "tags": ["productividad", "kanban", "proyectos"]}
                ],
                "ü§ñ Inteligencia Artificial": [
                    {"title": "ChatGPT", "url": "https://chat.openai.com", "description": "Chat de IA de OpenAI", "tags": []},
                    {"title": "Perplexity", "url": "https://www.perplexity.ai/?login-source=oneTapHome&login-new=false", "description": "Buscador con IA", "tags": []},
                    {"title": "Gemini", "url": "https://gemini.google.com", "description": "Gemini", "tags": []},
                    {"title": "Claude", "url": "https://claude.ai", "description": "Modelo de IA conversacional de Anthropic, gran competidor de ChatGPT.", "tags": ["ia", "chatbot", "anthropic"]},
                    {"title": "Poe", "url": "https://poe.com", "description": "Plataforma para chatear con m√∫ltiples bots de IA (ChatGPT, Claude, etc.) en un solo lugar.", "tags": ["ia", "chatbot", "agregador"]},
                    {"title": "Midjourney", "url": "https://www.midjourney.com", "description": "El generador de im√°genes por IA m√°s potente (se usa a trav√©s de Discord).", "tags": ["ia", "imagenes", "generador"]}
                ],
                "üß† Programaci√≥n": [
                    {"title": "Hugging Face", "url": "https://huggingface.co", "description": "Modelos de IA, datasets y herramientas colaborativas", "tags": []},
                    {"title": "Kaggle", "url": "https://www.kaggle.com", "description": "Competencias de IA, an√°lisis de datos y notebooks", "tags": []},
                    {"title": "freeCodeCamp", "url": "https://www.freecodecamp.org", "description": "Cursos gratuitos interactivos de HTML, CSS, JS y m√°s", "tags": []},
                    {"title": "W3Schools", "url": "https://www.w3schools.com", "description": "Tutoriales f√°ciles de HTML, CSS, JavaScript y m√°s", "tags": []},
                    {"title": "MDN Web Docs", "url": "https://developer.mozilla.org/es/", "description": "Documentaci√≥n oficial y ejemplos de HTML, CSS y JS", "tags": []},
                    {"title": "JavaScript Info", "url": "https://javascript.info", "description": "Gu√≠a completa y clara para aprender JavaScript", "tags": []},
                    {"title": "Codecademy", "url": "https://www.codecademy.com", "description": "Cursos pr√°cticos de programaci√≥n interactivos", "tags": []},
                    {"title": "SoloLearn", "url": "https://www.sololearn.com", "description": "Aprend√© programaci√≥n desde el celu o la compu con lecciones cortas", "tags": []},
                    {"title": "GeeksForGeeks", "url": "https://www.geeksforgeeks.org", "description": "Ejemplos, ejercicios y teor√≠a de programaci√≥n", "tags": []},
                    {"title": "Stack Overflow", "url": "https://www.stackoverflow.com", "description": "Pregunt√° y busc√° soluciones a problemas de c√≥digo", "tags": []},
                    {"title": "Figma", "url": "https://www.figma.com", "description": "Herramienta de dise√±o de interfaces (UI/UX) colaborativa basada en la web.", "tags": ["dise√±o", "ui", "ux", "frontend"]},
                    {"title": "CodePen", "url": "https://codepen.io", "description": "Patio de juegos online para probar y mostrar snippets de HTML, CSS y JavaScript.", "tags": ["frontend", "css", "js", "html", "demo"]},
                    {"title": "Replit", "url": "https://replit.com", "description": "IDE completo en la nube para programar, compilar y alojar proyectos en cualquier lenguaje.", "tags": ["ide", "nube", "programacion", "backend"]}
                ],
                "Descargas para Mac": [
                    {"title": "nMac.to", "url": "https://nmac.to/now/", "description": "nMac.to", "tags": []},
                    {"title": "MacTorrents", "url": "https://www.torrentmac.net/", "description": "MacTorrents", "tags": []}
                ]
            };
            const DEFAULT_ORDER = [
                "üîé B√∫squeda y Noticias", "üé¨ Entretenimiento", "üí¨ Redes Sociales", "üë®‚Äçüíª Tecnolog√≠a / Trabajo", "ü§ñ Inteligencia Artificial", "üß† Programaci√≥n", "Descargas para Mac"
            ];
            // -----------------------------------------------

            // --- Elementos del DOM ---
            const elements = {
                categoriesContainer: document.getElementById('categories-container'),
                categoryModal: document.getElementById('category-modal'),
                linkModal: document.getElementById('link-modal'),
                modalCloseBtns: document.querySelectorAll('.modal-close-btn'),
                categoryForm: document.getElementById('category-form'),
                categoryModalTitle: document.getElementById('category-modal-title'),
                linkForm: document.getElementById('link-form'),
                linkModalTitle: document.getElementById('link-modal-title'),
                categoryNameInput: document.getElementById('category-name'),
                linkTitleInput: document.getElementById('link-title'),
                linkUrlInput: document.getElementById('link-url'),
                linkCategorySelect: document.getElementById('link-category'),
                linkDescriptionInput: document.getElementById('link-description'),
                linkTagsInput: document.getElementById('link-tags'),
                addCategoryBtn: document.getElementById('add-category-btn'),
                addLinkBtn: document.getElementById('add-link-btn'),
                categoryError: document.getElementById('category-error'),
                linkError: document.getElementById('link-error'),
                undoToast: document.getElementById('undo-toast'),
                undoBtn: document.getElementById('undo-btn'),
                searchInput: document.getElementById('search-input'),
                importBtn: document.getElementById('import-btn'),
                exportBtn: document.getElementById('export-btn'),
                importFileInput: document.getElementById('import-file'),
                themeToggleBtn: document.getElementById('theme-toggle-btn'),
                themeIcon: document.getElementById('theme-toggle-btn').querySelector('ion-icon'),
                backToTopBtn: document.getElementById('back-to-top-btn')
            };

            // --- Estado de la Aplicaci√≥n ---
            let bookmarksData = {};
            let categoryOrder = [];
            let undoState = null; 
            let undoTimeout = null; 
            let editState = null; 

            // --- Funciones de Datos (migrate, load, save) ---
            function migrateData() {
                let needsSave = false;
                categoryOrder.forEach(category => {
                    if (bookmarksData[category]) {
                        bookmarksData[category].forEach(link => {
                            if (link.description === undefined) { link.description = ""; needsSave = true; }
                            if (link.tags === undefined) { link.tags = []; needsSave = true; }
                        });
                    } else {
                        categoryOrder = categoryOrder.filter(c => c !== category);
                        needsSave = true;
                    }
                });
                for (const categoryName in bookmarksData) {
                    if (!categoryOrder.includes(categoryName)) {
                        categoryOrder.push(categoryName);
                        needsSave = true;
                    }
                }
                if (needsSave) { saveData(); }
            }

            function loadData() {
                const savedData = localStorage.getItem(STORAGE_KEY_BOOKMARKS);
                const savedOrder = localStorage.getItem(STORAGE_KEY_ORDER);
                bookmarksData = savedData ? JSON.parse(savedData) : DEFAULT_BOOKMARKS;
                categoryOrder = savedOrder ? JSON.parse(savedOrder) : DEFAULT_ORDER;
                if (!savedData && !savedOrder) {
                    saveData(); 
                }
                migrateData();
            }
            
            function saveData() {
                localStorage.setItem(STORAGE_KEY_BOOKMARKS, JSON.stringify(bookmarksData));
                localStorage.setItem(STORAGE_KEY_ORDER, JSON.stringify(categoryOrder));
            }
            
            function getDomain(url) {
                try {
                    const parsedUrl = new URL(url);
                    return parsedUrl.hostname.replace('www.', '');
                } catch (e) { return 'enlace.com'; }
            }
            
            // --- NUEVA FUNCI√ìN RENDER (MINIMALISTA) ---
            function renderPage() {
                elements.categoriesContainer.innerHTML = ''; 
                hideUndoToast();

                if (categoryOrder.length === 0) {
                    elements.categoriesContainer.innerHTML = `
                        <div class="text-center text-gray-500 dark:text-gray-400 py-20">
                            <ion-icon name="rocket-outline" class="text-6xl text-accent-500"></ion-icon>
                            <h2 class="text-2xl font-semibold mt-4">Plataforma de lanzamiento vac√≠a</h2>
                            <p class="mt-2">A√±ade una categor√≠a o importa tu copia de seguridad.</p>
                        </div>
                    `;
                    return;
                }

                categoryOrder.forEach(categoryName => {
                    if (!bookmarksData[categoryName]) return; 

                    const links = bookmarksData[categoryName];
                    const categoryEl = document.createElement('section');
                    categoryEl.className = 'category-section';
                    
                    categoryEl.innerHTML = `
                        <div class="category-header group flex justify-between items-center mb-3">
                            <div class="flex items-center gap-2">
                                <div class="category-drag-handle cursor-move text-gray-400 dark:text-gray-600 p-1" title="Mover categor√≠a">
                                    <ion-icon name="reorder-two-outline" class="text-2xl"></ion-icon>
                                </div>
                                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">${categoryName} 
                                    <span class="text-xl font-medium text-gray-500 dark:text-gray-400">(${links.length})</span>
                                </h2>
                            </div>
                            <div class="category-actions flex items-center gap-2 text-gray-500">
                                <button class="edit-category-btn hover:text-accent-500 p-1" data-category="${categoryName}" title="Renombrar categor√≠a">
                                    <ion-icon name="pencil-outline" class="text-lg"></ion-icon>
                                </button>
                                <button class="delete-category-btn hover:text-red-500 p-1" data-category="${categoryName}" title="Eliminar categor√≠a">
                                    <ion-icon name="trash-outline" class="text-lg"></ion-icon>
                                </button>
                            </div>
                        </div>
                        <ul class="links-list border border-gray-200 dark:border-gray-800 rounded-lg overflow-hidden">
                            </ul>
                    `;

                    const linksList = categoryEl.querySelector('.links-list');

                    if (links.length > 0) {
                        links.forEach((link, index) => {
                            const domain = getDomain(link.url);
                            const faviconUrl = `https://www.google.com/s2/favicons?sz=32&domain=${domain}`;
                            const tagsHTML = (link.tags || []).map(tag => 
                                `<span class="link-tag-span text-xs font-medium bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300 px-2 py-0.5 rounded-full">${tag}</span>`
                            ).join('');

                            const faviconHTML = `
                                <div class="w-5 h-5 flex-shrink-0">
                                    <img src="${faviconUrl}" alt="" class="w-5 h-5 rounded-sm" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="w-5 h-5 rounded-sm bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-400 dark:text-gray-500" style="display: none;">
                                        <ion-icon name="globe-outline" class="text-sm"></ion-icon>
                                    </div>
                                </div>
                            `;
                            
                            const linkEl = document.createElement('li');
                            linkEl.className = "link-item group flex items-center justify-between p-3.5 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 last:border-b-0 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors";
                            
                            linkEl.innerHTML = `
                                <div class="flex items-center gap-3 flex-1 min-w-0">
                                    <div class="link-drag-handle cursor-move text-gray-400 dark:text-gray-500" title="Mover enlace">
                                        <ion-icon name="reorder-two-outline" class="text-2xl"></ion-icon>
                                    </div>
                                    ${faviconHTML}
                                    <a href="${link.url}" target="_blank" class="flex-1 min-w-0" title="${link.description || link.title}">
                                        <div class="link-title font-medium text-gray-900 dark:text-gray-100 truncate">${link.title}</div>
                                        <div class="link-url text-sm text-gray-500 dark:text-gray-400 truncate">${link.url.replace('https://', '').replace('www.', '')}</div>
                                    </a>
                                </div>
                                <div class="flex items-center gap-4 pl-2">
                                    <div class="hidden md:flex flex-wrap gap-1.5">${tagsHTML}</div>
                                    <div class="link-actions flex gap-1 text-gray-500">
                                        <button class="edit-link-btn hover:text-accent-500 p-1" data-category="${categoryName}" data-index="${index}" title="Editar enlace">
                                            <ion-icon name="pencil-outline" class="text-lg"></ion-icon>
                                        </button>
                                        <button class="delete-link-btn hover:text-red-500 p-1" data-category="${categoryName}" data-index="${index}" title="Eliminar enlace">
                                            <ion-icon name="close-outline" class="text-lg"></ion-icon>
                                        </button>
                                    </div>
                                </div>
                            `;
                            linksList.appendChild(linkEl);
                        });
                    } else {
                        linksList.innerHTML = `<li class="p-4 text-gray-500 dark:text-gray-400 italic text-sm">No hay enlaces en esta categor√≠a.</li>`;
                    }

                    elements.categoriesContainer.appendChild(categoryEl);

                    // SortableJS para ENLACES
                    new Sortable(linksList, {
                        animation: 150,
                        ghostClass: 'sortable-ghost', 
                        draggable: '.link-item',
                        handle: '.link-drag-handle',
                        onEnd: (evt) => {
                            const category = evt.from.dataset.category;
                            const [movedItem] = bookmarksData[category].splice(evt.oldIndex, 1);
                            bookmarksData[category].splice(evt.newIndex, 0, movedItem);
                            saveData();
                            renderPage(); 
                        }
                    });
                });

                // SortableJS para CATEGOR√çAS
                new Sortable(elements.categoriesContainer, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    draggable: '.category-section', 
                    handle: '.category-drag-handle',
                    onEnd: (evt) => {
                        const [movedItem] = categoryOrder.splice(evt.oldIndex, 1);
                        categoryOrder.splice(evt.newIndex, 0, movedItem);
                        saveData(); 
                    }
                });

                updateCategorySelect();
            }

            // --- Resto de funciones (sin cambios) ---
            function updateCategorySelect(){elements.linkCategorySelect.innerHTML='';let e=elements.linkCategorySelect.value;categoryOrder.forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t,elements.linkCategorySelect.appendChild(n)}),categoryOrder.includes(e)&&(elements.linkCategorySelect.value=e)}
            function showModal(e){hideErrorMessages(),e.classList.add("flex")}
            function hideModal(e){e.classList.remove("flex"),elements.categoryForm.reset(),elements.linkForm.reset(),editState=null,elements.categoryModalTitle.textContent="Crear Nueva Categor√≠a",elements.linkModalTitle.textContent="A√±adir Nuevo Enlace"}
            function hideErrorMessages(){elements.categoryError.classList.add("hidden"),elements.linkError.classList.add("hidden")}
            function showUndoToast(e,t,n){clearTimeout(undoTimeout),undoState={category:e,index:t,linkData:n},elements.undoToast.classList.add("show"),undoTimeout=setTimeout(hideUndoToast,5e3)}
            function hideUndoToast(){elements.undoToast.classList.remove("show"),undoState=null,clearTimeout(undoTimeout)}
            function handleUndoClick(){if(!undoState)return;const{category:e,index:t,linkData:n}=undoState;bookmarksData[e].splice(t,0,n),saveData(),renderPage(),hideUndoToast()}
            function showEditCategoryModal(e){editState={type:"category",oldName:e},elements.categoryNameInput.value=e,elements.categoryModalTitle.textContent="Renombrar Categor√≠a",showModal(elements.categoryModal)}
            function showEditLinkModal(e,t){editState={type:"link",category:e,index:t};const n=bookmarksData[e][t];elements.linkTitleInput.value=n.title,elements.linkUrlInput.value=n.url,elements.linkDescriptionInput.value=n.description||"",elements.linkTagsInput.value=(n.tags||[]).join(", "),updateCategorySelect(),elements.linkCategorySelect.value=e,elements.linkModalTitle.textContent="Editar Enlace",showModal(elements.linkModal)}
            function handleSearch(){const e=elements.searchInput.value.toLowerCase();document.querySelectorAll(".category-section").forEach(t=>{let n=!1;const o=t.querySelectorAll(".link-item");o.length>0?o.forEach(t=>{const o=(t.querySelector(".link-title")?.textContent||"").toLowerCase(),a=(t.title||"").toLowerCase(),i=Array.from(t.querySelectorAll(".link-tag-span")).map(e=>e.textContent.toLowerCase()).join(" "),c=`${o} ${a} ${i}`;c.includes(e)?(t.classList.remove("hidden"),n=!0):t.classList.add("hidden")}):n=!1,n||""===e||t.querySelector("h2").textContent.toLowerCase().includes(e)?t.classList.remove("hidden"):t.classList.add("hidden")})}
            function exportData(){const e={bookmarks:bookmarksData,order:categoryOrder},t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),o=URL.createObjectURL(n),a=document.createElement("a");a.href=o,a.download="favoritos_backup.json",a.click(),URL.revokeObjectURL(o)}
            function importData(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=e=>{let t="replace";try{const n=JSON.parse(e.target.result);if(!n.bookmarks||!n.order)throw new Error("El archivo no tiene el formato correcto.");confirm('¬øQuieres COMBINAR los enlaces del archivo con los actuales? \n\n(Presiona "Cancelar" para REEMPLAZAR todo).')?(t="merge",Object.keys(n.bookmarks).forEach(e=>{bookmarksData.hasOwnProperty(e)?n.bookmarks[e].forEach(t=>{bookmarksData[e].some(e=>e.url===t.url)||bookmarksData[e].push(t)}):(bookmarksData[e]=n.bookmarks[e],categoryOrder.includes(e)||categoryOrder.push(e))})):(t="replace",bookmarksData=n.bookmarks,categoryOrder=n.order),migrateData(),saveData(),renderPage(),"merge"===t?alert("¬°Enlaces combinados con √©xito!"):alert("¬°Importaci√≥n (reemplazo) exitosa!")}catch(e){alert("Error: "+e.message)}elements.importFileInput.value=""},n.readAsText(t)}
            function applyTheme(e){"light"===e?(document.documentElement.classList.remove("dark"),elements.themeIcon.setAttribute("name","moon-outline")):(document.documentElement.classList.add("dark"),elements.themeIcon.setAttribute("name","sunny-outline")),localStorage.setItem(STORAGE_KEY_THEME,e)}
            function toggleTheme(){const e=document.documentElement.classList.contains("dark")?"dark":"light";applyTheme("dark"===e?"light":"dark")}
            function handleScroll(){window.scrollY>300?(elements.backToTopBtn.classList.remove("hidden"),elements.backToTopBtn.classList.add("flex")):(elements.backToTopBtn.classList.add("hidden"),elements.backToTopBtn.classList.remove("flex"))}

            // --- Manejadores de Eventos ---
            elements.addCategoryBtn.addEventListener('click', () => {
                editState = null; 
                elements.categoryModalTitle.textContent = 'Crear Nueva Categor√≠a';
                showModal(elements.categoryModal);
            });
            elements.addLinkBtn.addEventListener('click', () => {
                if (categoryOrder.length === 0) {
                    showModal(elements.categoryModal);
                    elements.categoryError.textContent = 'Debes crear una categor√≠a primero.';
                    elements.categoryError.classList.remove("hidden");
                    return;
                }
                editState = null; 
                elements.linkModalTitle.textContent = 'A√±adir Nuevo Enlace';
                updateCategorySelect();
                showModal(elements.linkModal);
            });
            elements.modalCloseBtns.forEach(btn => {
                btn.addEventListener('click', (e) => hideModal(e.target.closest('.modal')));
            });
            elements.categoryForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newName = elements.categoryNameInput.value.trim();
                if (!newName) return;
                if (editState && editState.type === 'category') {
                    const oldName = editState.oldName;
                    if (newName === oldName) { hideModal(elements.categoryModal); return; }
                    if (bookmarksData.hasOwnProperty(newName)) {
                        elements.categoryError.textContent = 'Esa categor√≠a ya existe.';
                        elements.categoryError.classList.remove("hidden");
                        return;
                    }
                    bookmarksData[newName] = bookmarksData[oldName];
                    delete bookmarksData[oldName];
                    const index = categoryOrder.indexOf(oldName);
                    if (index > -1) { categoryOrder[index] = newName; }
                } else {
                    if (bookmarksData.hasOwnProperty(newName)) {
                        elements.categoryError.textContent = 'Esa categor√≠a ya existe.';
                        elements.categoryError.classList.remove("hidden");
                        return;
                    }
                    bookmarksData[newName] = []; 
                    categoryOrder.push(newName); 
                }
                saveData();
                renderPage();
                hideModal(elements.categoryModal);
            });
            elements.linkForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const title = elements.linkTitleInput.value.trim();
                const url = elements.linkUrlInput.value.trim();
                const category = elements.linkCategorySelect.value;
                const description = elements.linkDescriptionInput.value.trim();
                const tags = elements.linkTagsInput.value.trim().split(',').map(tag => tag.trim()).filter(tag => tag !== ''); 
                if (!title || !url || !category) {
                    elements.linkError.textContent = 'Por favor completa todos los campos.';
                    elements.linkError.classList.remove("hidden");
                    return;
                }
                const finalUrl = (url.startsWith('http://') || url.startsWith('https://')) ? url : `https://${url}`;
                const newLink = { title, url: finalUrl, description, tags };
                if (editState && editState.type === 'link') {
                    const oldCategory = editState.category;
                    const oldIndex = editState.index;
                    if (oldCategory === category) {
                        bookmarksData[oldCategory][oldIndex] = newLink;
                    } else {
                        bookmarksData[oldCategory].splice(oldIndex, 1); 
                        bookmarksData[category].push(newLink); 
                    }
                } else {
                    bookmarksData[category].push(newLink);
                }
                saveData();
                renderPage();
                hideModal(elements.linkModal);
            });
            elements.undoBtn.addEventListener('click', handleUndoClick);
            elements.searchInput.addEventListener('input', handleSearch);
            elements.exportBtn.addEventListener('click', exportData);
            elements.importBtn.addEventListener('click', () => elements.importFileInput.click());
            elements.importFileInput.addEventListener('change', importData);
            elements.themeToggleBtn.addEventListener('click', toggleTheme);
            window.addEventListener('scroll', handleScroll);
            elements.backToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            elements.categoriesContainer.addEventListener('click', (e) => {
                const linkAnchor = e.target.closest('a');
                const dragHandle = e.target.closest('.link-drag-handle, .category-drag-handle');
                const button = e.target.closest('button');

                if (linkAnchor && !button && !dragHandle) {
                    return; // Permite que el enlace funcione
                }
                
                if (button || dragHandle) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                const editLinkBtn = e.target.closest('.edit-link-btn');
                if (editLinkBtn) {
                    showEditLinkModal(editLinkBtn.dataset.category, parseInt(editLinkBtn.dataset.index, 10));
                    return;
                }
                const deleteLinkBtn = e.target.closest('.delete-link-btn');
                if (deleteLinkBtn) {
                    const category = deleteLinkBtn.dataset.category;
                    const index = parseInt(deleteLinkBtn.dataset.index, 10);
                    const deletedLink = bookmarksData[category].splice(index, 1)[0];
                    saveData();
                    renderPage(); 
                    showUndoToast(category, index, deletedLink);
                    return; 
                }
                const editCategoryBtn = e.target.closest('.edit-category-btn');
                if (editCategoryBtn) {
                    showEditCategoryModal(editCategoryBtn.dataset.category);
                    return;
                }
                const deleteCategoryBtn = e.target.closest('.delete-category-btn');
                if (deleteCategoryBtn) {
                    const category = deleteCategoryBtn.dataset.category;
                    if (confirm(`¬øSeguro que quieres eliminar la categor√≠a "${category}" y todos sus enlaces?`)) {
                        delete bookmarksData[category]; 
                        categoryOrder = categoryOrder.filter(c => c !== category); 
                        saveData();
                        renderPage(); 
                    }
                }
            });

            // --- INICIALIZACI√ìN ---
            // Aplica el tema guardado ANTES de cargar la p√°gina para evitar "flash"
            const savedTheme = localStorage.getItem(STORAGE_KEY_THEME) || 'light'; // Default a 'light'
            applyTheme(savedTheme);
            
            loadData(); // Carga (desde predeterminados o localStorage) y migra los datos
            renderPage();
        });
    </script>
</body>
</html>
